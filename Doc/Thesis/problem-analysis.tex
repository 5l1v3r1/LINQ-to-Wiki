\chapter{Problem analysis}
\label{goal}

The goal of the LinqToWiki library is to be able to express requests using the MediaWiki \ac{API}
in a way that is readable, discoverable, checked by the compiler for correctness as much as possible and also flexible with regards to changes.

This is achieved by generating classes specific for each module and using them in LINQ queries.

\paragraph{Querying data in C\#}

\ac{LINQ} is a way of querying various data sources from the C\# language.
The two most commonly used variants are LINQ to Objects, and various versions of LINQ for \ac{SQL} databases.
LINQ to Objects is used for querying in-memory data, like arrays.
There are several widely-used libraries for accessing \ac{SQL} databases using LINQ, including LINQ to SQL, LINQ to Entities and NHibernate.

In all versions of \ac{LINQ}, the queries look the same. For example:

\begin{lstlisting}
from product in products
where product.Price > 500
   && product.InStock
join category in categories on product.Category equals category
orderby product.Price
select product.Name
\end{lstlisting}

A query like this is translated into a sequence of method calls that take their parameters in the form of lambda expressions.
For example, the \lstinline{where} part of the above query is translated into:

\begin{lstlisting}
products.Where(product => product.Price > 500 && product.InStock)
\end{lstlisting}

The commonalities between LINQ to Objects and SQL LINQ libraries are that the full range of operators is available
and that all properties of the queried type are available in all of them.

\paragraph{Querying MediaWiki}

The situation with the MediaWiki \ac{API} is different in several ways:

\begin{enumerate}
\item It does not support queries represented by many of the LINQ operators, including \lstinline{join} and \lstinline{group by}.
\item Some of the modules do not support sorting, some do. Of those that do support sorting, some allow specifying the sort key, others only the direction.
\item The sets of properties that are available for filtering, sorting and selecting are all different.
\item There are modules used for queries about a set of pages. Those pages can be from a hard-coded list or a result from some other module.
\item There are also parameters that do not fit into the LINQ model well. Some of them are required, some are not.
\end{enumerate}

The goal is to be able to represent all valid queries, while invalid queries should cause a compile-time error.

Specifically, unsupported operators (like \lstinline{join} and \lstinline{group by}) should cause an error for all modules,
while the \lstinline{orderby} clause should cause an error only for the modules that do not support sorting.

Also, all operators should support only those properties that are actually supported by the \ac{API}.
So, for example for the \verb,blocks, module, the following query should compile and execute fine:

\begin{lstlisting}
from block in wiki.Blocks()
where block.Ip == "8.8.8.8"
orderby block descending
select block.ById
\end{lstlisting}

This is because
\begin{compactitem}
\item limiting the query by the blocked \ac{IP} address,
\item sorting without specifying the key and
\item selecting the ID of the user who performed the block
\end{compactitem}
are all allowed, while the following query should cause three errors:

\begin{lstlisting}
from block in wiki.Blocks()
where block.ById == 1234
orderby block.Expiry descending
select block.Ip
\end{lstlisting}

Here,
\begin{compactitem}
\item limiting by the ID of the user who performed the block,
\item sorting by the expiration date and
\item selecting the \ac{IP} address
\end{compactitem}
are all impossible.
(Actually selecting the \ac{IP} address of the blocked user is possible,
but the information is contained in properties with different names.)

\section{Sample queries}

Following are samples of queries of different modules using LinqToWiki:

\begin{lstlisting}
string diff = wiki.compare(fromrev: 486474789,
                              torev: 487063697)
                    .value;
\end{lstlisting}

This query compares the text of two revisions and returns differences between them.
It shows that queries for modules that return a single item take their parameters as named method parameters
and directly return their result.

\begin{lstlisting}
var pages = wiki.Query.querypage(querypagepage.Uncategorizedpages)
                  .ToList();
\end{lstlisting}

This query returns a list of uncategorized pages,
as provided by the special page \texttt{Special:UncategorizedPages}.
It shows that required parameters to list-returning modules are given as method parameters
and that \lstinline{ToList()} (or, alternatively, \lstinline{ToEnumerable()})
has to be called on the result before it can be used.

\begin{lstlisting}
var pages = (from cm in wiki.Query.categorymembers()
	       where cm.title == "Category:Query languages"
	           && cm.type == categorymemberstype.subcat
	       select cm).Pages;
\end{lstlisting}

This query returns subcategories of the category \texttt{Query languages}.
The result is not actually directly usable, but it can be used in so called \texttt{prop} queries.
The query shows how LINQ can be used for querying list-returning modules
and that the \lstinline{Pages} property is used to create source for further queries.

\begin{lstlisting}
var result = pages.Select(
	p =>
	new
	{
		Info = p.info,
		Images = p.images().ToEnumerable()
	})
	.ToEnumerable();
\end{lstlisting}

This query returns information about images present on a list of pages specified by \lstinline{pages}
(see previous query).
It shows how the result of one query can be used as a source for another query,
how the LINQ method \lstinline{Select()} is used in such queries,
how anonymous types can be used to return the required information
and how \lstinline{ToEnumerable()} (or \lstinline{ToList()}) has to be also used inside this kind of queries.